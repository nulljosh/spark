<!DOCTYPE html>
<html data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/icon-192.svg">
    <title>Spark</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root[data-theme="dark"] {
            --bg: #000;
            --surface: #111;
            --surface2: #1c1c1e;
            --surface3: #2c2c2e;
            --text: #f5f5f7;
            --text2: #98989d;
            --text3: #636366;
            --border: rgba(255,255,255,0.06);
            --modal-bg: rgba(0,0,0,0.9);
        }
        :root[data-theme="light"] {
            --bg: #ffffff;
            --surface: #f5f5f7;
            --surface2: #ebebeb;
            --surface3: #e0e0e0;
            --text: #111111;
            --text2: #636366;
            --text3: #98989d;
            --border: #c5c5ca;
            --modal-bg: rgba(0,0,0,0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        body { font-family: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif; font-weight: 300; background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; transition: background 0.2s, color 0.2s; }
        main { flex: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-left h1 { font-size: 48px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .subtitle { color: var(--text3); margin-bottom: 40px; }
        .auth-btn { background: var(--surface2); color: var(--text); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .auth-btn:hover { background: var(--surface3); }
        .theme-btn { background: var(--surface2); color: var(--text); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .theme-btn:hover { background: var(--surface3); }
        .user-info { color: #0a84ff; font-weight: 500; }
        .idea { background: var(--surface); padding: 20px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .idea h3 { margin-bottom: 10px; }
        .idea p { color: var(--text2); margin-bottom: 15px; }
        .votes { display: flex; gap: 15px; align-items: center; }
        .vote-btn { background: var(--surface2); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 16px; cursor: pointer; color: var(--text3); font-weight: 700; transition: background 0.15s, color 0.15s; }
        .vote-btn:hover { background: var(--surface3); color: var(--text); }
        .vote-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .new-btn { position: fixed; bottom: 30px; right: 30px; background: #0a84ff; color: #fff; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .new-btn.hidden { display: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-bg); padding: 20px; z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-box { background: var(--surface); padding: 30px; border-radius: 15px; width: 100%; max-width: 500px; border: 1px solid var(--border); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { background: transparent; color: var(--text3); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .tab.active { background: var(--surface2); color: var(--text); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, textarea, select { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; font-size: 16px; margin-bottom: 15px; font-family: inherit; }
        textarea { min-height: 100px; }
        .btn { background: #0a84ff; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .close { float: right; font-size: 30px; cursor: pointer; color: var(--text3); }
        .error { color: #ff453a; font-size: 14px; margin-bottom: 10px; }
        .success { color: #30d158; font-size: 14px; margin-bottom: 10px; }
        footer { margin-top: 60px; padding: 30px 0 20px; border-top: 1px solid var(--border); color: var(--text3); font-size: 13px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        footer a { color: var(--text3); text-decoration: none; }
        footer a:hover { color: #0a84ff; }
        .tier-badge { display: inline-block; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; padding: 2px 7px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .tier-1 { background: #2a2a2a; color: #8e8e93; border: 1px solid #3a3a3a; }
        .tier-2 { background: #1a2a1a; color: #30d158; border: 1px solid #2a3a2a; }
        .tier-3 { background: #2a1a00; color: #ff9f0a; border: 1px solid #3a2a00; }
        :root[data-theme="light"] .tier-1 { background: #e8e8ed; color: #636366; border-color: #d1d1d6; }
        :root[data-theme="light"] .tier-2 { background: #e0f5e0; color: #248a3d; border-color: #c0e0c0; }
        :root[data-theme="light"] .tier-3 { background: #fff3e0; color: #c93400; border-color: #ffe0b0; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin: 20px 0 30px;
            flex-wrap: wrap;
        }
        .filter-group, .sort-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        /* Apple Liquid Glass -- filter/sort buttons */
        .filter-btn, .sort-btn {
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: var(--text1);
        }
        .filter-btn:hover, .sort-btn:hover {
            background: var(--bg3);
            border-color: var(--accent);
        }
        .filter-btn.active, .sort-btn.active {
            background: rgba(124, 58, 237, 0.8);
            backdrop-filter: blur(10px);
            border-color: rgba(124, 58, 237, 0.6);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
            color: white;
        }
        body.dark .filter-btn, body.dark .sort-btn {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Apple Liquid Glass -- post cards */
        .post {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        .post:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }
        body.dark .post {
            background: rgba(31, 41, 55, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        body.dark .post:hover {
            background: rgba(31, 41, 55, 0.85);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }</style>
</head>
<body>
    <main>
        <div class="header">
            <div class="header-left">
                <h1>Spark</h1>
            </div>
            <div class="header-right">
                <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle dark/light mode">&#9790;</button>
                <div id="authUI"></div>
            </div>
        </div>
        <p class="subtitle">Where ideas become reality</p>
        <div class="filters">
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterByCategory('all', event)">All</button>
                <button class="filter-btn" onclick="filterByCategory('tech', event)">Tech</button>
                <button class="filter-btn" onclick="filterByCategory('business', event)">Business</button>
                <button class="filter-btn" onclick="filterByCategory('health', event)">Health</button>
                <button class="filter-btn" onclick="filterByCategory('productivity', event)">Productivity</button>
                <button class="filter-btn" onclick="filterByCategory('finance', event)">Finance</button>
                <button class="filter-btn" onclick="filterByCategory('sustainability', event)">Sustainability</button>
            </div>
            <div class="sort-group">
                <button class="sort-btn active" onclick="setSortMode('hot', event)">Hot</button>
                <button class="sort-btn" onclick="setSortMode('new', event)">New</button>
            </div>
        </div>
        <div id="feed">Loading...</div>
    </main>

    <button class="new-btn hidden" id="newIdeaBtn" onclick="showNewIdeaModal()">+ New Idea</button>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-box">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <div class="tabs">
                <button class="tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="loginTab" class="tab-content active">
                <h2 style="margin-bottom:20px">Login</h2>
                <div id="loginError" class="error"></div>
                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">
                <button class="btn" onclick="login()">Login</button>
            </div>

            <div id="registerTab" class="tab-content">
                <h2 style="margin-bottom:20px">Register</h2>
                <div id="registerError" class="error"></div>
                <div id="registerSuccess" class="success"></div>
                <input type="text" id="registerUsername" placeholder="Username">
                <input type="email" id="registerEmail" placeholder="Email (optional)">
                <input type="password" id="registerPassword" placeholder="Password">
                <input type="password" id="registerConfirm" placeholder="Confirm Password">
                <button class="btn" onclick="register()">Register</button>
            </div>
        </div>
    </div>

    <!-- New Idea Modal -->
    <div class="modal" id="ideaModal">
        <div class="modal-box">
            <span class="close" onclick="closeIdeaModal()">&times;</span>
            <h2 style="margin-bottom:20px">New Idea</h2>
            <div id="ideaError" class="error"></div>
            <input type="text" id="title" placeholder="Title">
            <textarea id="content" placeholder="Describe your idea..."></textarea>
            <select id="category">
                <option value="tech">Tech</option>
                <option value="business">Business</option>
                <option value="social">Social</option>
                <option value="entertainment">Entertainment</option>
                <option value="whitepaper">Whitepaper</option>
                <option value="patent">Patent</option>
            </select>
            <button class="btn" onclick="submitIdea()">Submit</button>
        </div>
    </div>

    <footer>
        <span>&copy; 2026 Spark. All rights reserved.</span>
        <span>
            <a href="https://github.com/nulljosh/spark" target="_blank">GitHub</a>
            &nbsp;&middot;&nbsp;
            <a href="mailto:hello@heyitsmejosh.com">Contact</a>
        </span>
    </footer>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3030' : '';

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            const next = isDark ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('spark_theme', next);
            document.getElementById('themeBtn').innerHTML = isDark ? '&#9728;' : '&#9790;';
        }

        (function initTheme() {
            const saved = localStorage.getItem('spark_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            document.getElementById('themeBtn').innerHTML = saved === 'dark' ? '&#9790;' : '&#9728;';
        })();

        // Auth state management
        function getToken() { return localStorage.getItem('spark_token'); }
        function setToken(token) { localStorage.setItem('spark_token', token); }
        function getUser() {
            try {
                const user = localStorage.getItem('spark_user');
                return user ? JSON.parse(user) : null;
            } catch(e) { clearAuth(); return null; }
        }
        function setUser(user) { localStorage.setItem('spark_user', JSON.stringify(user)); }
        function clearAuth() {
            localStorage.removeItem('spark_token');
            localStorage.removeItem('spark_user');
        }
        function isLoggedIn() { return !!getToken(); }

        // UI updates
        function updateAuthUI() {
            const authUI = document.getElementById('authUI');
            const newIdeaBtn = document.getElementById('newIdeaBtn');

            if (isLoggedIn()) {
                try {
                    const user = getUser();
                    if (!user || !user.username) throw new Error('invalid user');
                    authUI.innerHTML = `
                        <div style="display:flex;gap:15px;align-items:center">
                            <a href="/user/${user.username}" style="color:var(--accent);text-decoration:none;font-size:14px">@${user.username}</a>
                            <button class="auth-btn" onclick="logout()">Logout</button>
                        </div>
                    `;
                    newIdeaBtn.classList.remove('hidden');
                } catch(e) {
                    clearAuth();
                    updateAuthUI();
                    return;
                }
            } else {
                authUI.innerHTML = `<div style="display:flex;gap:10px">
                    <button class="auth-btn" onclick="showAuthModal('register')">Register</button>
                    <button class="auth-btn" onclick="showAuthModal('login')">Sign In</button>
                </div>`;
                newIdeaBtn.classList.add('hidden');
            }
        }

        // Modal controls
        function showAuthModal(tab = 'login') {
            document.getElementById('authModal').classList.add('show');
            switchAuthTab(tab);
        }
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('loginError').textContent = '';
            document.getElementById('registerError').textContent = '';
            document.getElementById('registerSuccess').textContent = '';
        }
        function showNewIdeaModal() {
            if (!isLoggedIn()) { showAuthModal(); return; }
            document.getElementById('ideaModal').classList.add('show');
        }
        function closeIdeaModal() {
            document.getElementById('ideaModal').classList.remove('show');
            document.getElementById('ideaError').textContent = '';
        }
        function switchAuthTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'login') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('registerTab').classList.add('active');
            }
        }

        // Auth functions
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            if (!username || !password) { errorEl.textContent = 'Please enter username and password'; return; }
            try {
                const res = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) { errorEl.textContent = data.error || 'Login failed'; return; }
                setToken(data.token);
                setUser({ username: data.username, userId: data.userId });
                closeAuthModal();
                updateAuthUI();
                load();
            } catch (e) { errorEl.textContent = 'Network error: ' + e.message; }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');
            errorEl.textContent = '';
            successEl.textContent = '';
            if (!username || !password || !confirm) { errorEl.textContent = 'Please fill in all required fields'; return; }
            if (password !== confirm) { errorEl.textContent = 'Passwords do not match'; return; }
            if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters'; return; }
            try {
                const res = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email: email || undefined, password })
                });
                const data = await res.json();
                if (!res.ok) { errorEl.textContent = data.error || 'Registration failed'; return; }
                setToken(data.token);
                setUser({ username: data.username, userId: data.userId });
                successEl.textContent = 'Registration successful!';
                setTimeout(() => { closeAuthModal(); updateAuthUI(); load(); }, 1000);
            } catch (e) { errorEl.textContent = 'Network error: ' + e.message; }
        }

        function logout() { clearAuth(); updateAuthUI(); load(); }

        // Feed
        function getTier(score) {
            if (score >= 1000000) return { level: 3, label: 'TIER 3' };
            if (score >= 1000) return { level: 2, label: 'TIER 2' };
            if (score >= 100) return { level: 1, label: 'TIER 1' };
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderIdea(p) {
            const score = p.score || 0;
            const tier = getTier(score);
            const tierHtml = tier ? `<span class="tier-badge tier-${tier.level}">${tier.label}</span>` : '';
            return `
                <div class="idea">
                    <div style="color:var(--text3);font-size:12px;margin-bottom:10px">${escapeHtml(p.category).toUpperCase()} &bull; @${escapeHtml(p.author?.username || 'unknown')}</div>
                    <h3>${escapeHtml(p.title)}</h3>
                    <p>${escapeHtml(p.content)}</p>
                    <div class="votes">
                        <button class="vote-btn" onclick="vote('${p.id}','up')" ${!isLoggedIn() ? 'disabled' : ''}>&#9650;</button>
                        <span style="font-weight:600">${score}${tierHtml}</span>
                        <button class="vote-btn" onclick="vote('${p.id}','down')" ${!isLoggedIn() ? 'disabled' : ''}>&#9660;</button>
                    </div>
                </div>
            `;
        }

        async function load() {
            try {
                const res = await fetch(`${API_BASE}/api/posts`);
                const data = await res.json();
                if (data.error || !data.posts || data.posts.length === 0) {
                    document.getElementById('feed').innerHTML = `<div style="color:var(--text3);text-align:center;padding:40px">No ideas yet. Be the first to share one!</div>`;
                    return;
                }
                let posts = data.posts;
                
                // Filter by category
                if (window.currentFilter && window.currentFilter !== 'all') {
                    posts = posts.filter(p => p.category === window.currentFilter);
                }
                
                // Sort: hot (by score desc) or new (by date desc)
                if (window.sortMode === 'new') {
                    posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } else {
                    posts.sort((a, b) => b.score - a.score);
                }
                
                document.getElementById('feed').innerHTML = posts.length > 0 ? posts.map(p => renderIdea(p)).join('') : `<div style="color:var(--text3);text-align:center;padding:40px">No ideas in this category.</div>`;
            } catch(e) {
                document.getElementById('feed').innerHTML = `<div style="color:var(--text3);text-align:center;padding:40px">Failed to load ideas. Try again later.</div>`;
            }
        }

        async function vote(id, type) {
            if (!isLoggedIn()) { showAuthModal(); return; }
            try {
                const res = await fetch(`${API_BASE}/api/posts/${id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
                    body: JSON.stringify({ voteType: type })
                });
                if (!res.ok) { const data = await res.json(); alert(data.error || 'Failed to vote'); return; }
                load();
            } catch (e) { alert('Network error: ' + e.message); }
        }

        async function submitIdea() {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const category = document.getElementById('category').value;
            const errorEl = document.getElementById('ideaError');
            if (!title || !content) { errorEl.textContent = 'Please enter both title and description'; return; }
            try {
                const res = await fetch(`${API_BASE}/api/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
                    body: JSON.stringify({ title, content, category })
                });
                const data = await res.json();
                if (!res.ok) { errorEl.textContent = data.error || 'Failed to post idea'; return; }
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                closeIdeaModal();
                load();
            } catch (e) { errorEl.textContent = 'Network error: ' + e.message; }
        }

        // Filter and sort state
        window.currentFilter = 'all';
        window.sortMode = 'hot';

        function filterByCategory(cat, e) {
            window.currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            (e || event).target.classList.add('active');
            load();
        }

        function setSortMode(mode, e) {
            window.sortMode = mode;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            (e || event).target.classList.add('active');
            load();
        }

        // Initialize
        updateAuthUI();
        load();
        setInterval(load, 30000);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>
